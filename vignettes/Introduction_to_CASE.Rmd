---
title: "Introduction to CASE for multi-cell-type eQTL fine-mapping"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction_to_CASE}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# This Vignette is a draft and will be further updated.

First, we load necessary packages.

```{r setup}
library(CASE)
library(ggplot2)
library(susieR)
set.seed(1000)
```

## The example data

```{r}
data("example_data")
attach(example_data)

N = nrow(X)
M = ncol(X)
C = ncol(Y)
cat(" Sample size =", N, "\n",
    "SNP size =", M, "\n",
    "Cell type number =", C, "\n")
```

Let's have a look at the Linkage Disequilibrium (LD) of the example genotype.

```{r}
R = cor(X)

df <- expand.grid(seq(M), seq(M))
df$corr <- as.vector(R)

g2 = ggplot(df, aes(x = Var1, y = Var2, fill = corr)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", limits = c(-1, 1),
                       midpoint = 0, na.value = NA,
                       guide = guide_colorbar(
                         barwidth = 1, barheight = 7, title.position = "top", oob = scales::oob_squish
                       )
                       ) +
  xlab("") + 
  ylab("") +
  theme(aspect.ratio = 1, axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        strip.background = element_rect(fill = "white", color = "white"),
        panel.border = element_rect(colour = "black", fill = NA, 
                                    linewidth = 1),
        strip.text = element_text(color = "black", size = 20),
        text = element_text(size = 20)) +
  labs(fill = "corr")
print(g2)
```
Only SNP 10 have eQTL effects for three cell types and SNP 950 have eQTL effects for the first two cell types. 

```{r}
print(which(B != 0, arr.ind = TRUE))
idx1 = 10
idx2 = 950
B[c(idx1, idx2), ]
```
Check the Z scores for the causal SNPs.

```{r}
Z = matrix(0, M, C)
for (i in 1:M){
  m1 = summary(lm(Y ~ X[, i]))
  Z[i, ] = sapply(m1, function(x) x$coefficients[2, 3])
}
Z[c(idx1, idx2), ] 
```

## Fine-mapping

First, we try a single-trait fine-mapping method, SuSiE (Wang et al. 2020), for each cell type separately. The results lacks power for the third cell type and for SNP 950.

```{r}
for (c in 1:C){
  f1 = susie_rss(z = Z[, c], R = R, n = N)
  print(f1$sets)
}
```

However, CASE jointly studies three traits together to improve the power of identifying the causal variants.

```{r}
fit <- CASE(Z = Z, R = R, N = rep(N, C))
print(fit$sets)
```

## Session Information

```{r}
sessionInfo()
```
